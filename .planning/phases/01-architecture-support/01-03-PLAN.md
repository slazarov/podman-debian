---
phase: 01-architecture-support
plan: 03
type: execute
wave: 2
depends_on: [01-01]
files_modified: [scripts/install_protoc.sh]
autonomous: true
requirements: [ARCH-03]

must_haves:
  truths:
    - "Protoc installer downloads correct binary for system architecture"
    - "On amd64 system, Protoc downloads linux-x86_64.zip"
    - "On ARM64 system, Protoc downloads linux-aarch_64.zip"
  artifacts:
    - path: "scripts/install_protoc.sh"
      provides: "Architecture-aware Protoc installation"
      pattern: "PROTOC_ARCH"
  key_links:
    - from: "scripts/install_protoc.sh"
      to: "config.sh.example"
      via: "source and variable expansion"
      pattern: "linux-\\$PROTOC_ARCH"
---

<objective>
Update Protoc installer to use architecture-aware download URLs.

Purpose: Enable Protoc installation on both amd64 and ARM64 systems by replacing hardcoded architecture with $PROTOC_ARCH variable.

Output: Updated scripts/install_protoc.sh that downloads correct Protoc binary for the detected architecture.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-architecture-support/01-RESEARCH.md

<interfaces>
<!-- Key interfaces from existing codebase and Plan 01 -->

From config.sh.example (after Plan 01):
```bash
export ARCH="${ARCH:-$(detect_architecture)}"  # "amd64" or "arm64"
# PROTOC_ARCH mapping:
#   amd64 -> "x86_64"
#   arm64 -> "aarch_64"
export PROTOC_VERSION="33.1"
export PROTOC_TAG="v${PROTOC_VERSION}"
export PROTOC_ROOT_FOLDER="/opt/protoc"
export PROTOC_PATH="${PROTOC_ROOT_FOLDER}/${PROTOC_VERSION}/bin/protoc"
```

From scripts/install_protoc.sh (current - lines 16-20):
```bash
# Download Protoc
wget https://github.com/protocolbuffers/protobuf/releases/download/${PROTOC_TAG}/protoc-${PROTOC_VERSION}-linux-x86_64.zip -O protoc-${PROTOC_VERSION}-linux-x86_64.zip

mkdir -p ${PROTOC_ROOT_FOLDER}/${PROTOC_VERSION}
unzip protoc-${PROTOC_VERSION}-linux-x86_64.zip -d ${PROTOC_ROOT_FOLDER}/${PROTOC_VERSION}
```

Protoc download URL patterns:
- amd64: https://github.com/protocolbuffers/protobuf/releases/download/v33.1/protoc-33.1-linux-x86_64.zip
- arm64: https://github.com/protocolbuffers/protobuf/releases/download/v33.1/protoc-33.1-linux-aarch_64.zip
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update install_protoc.sh to use $PROTOC_ARCH variable</name>
  <files>scripts/install_protoc.sh</files>
  <action>
Update scripts/install_protoc.sh to use the $PROTOC_ARCH variable instead of hardcoded `x86_64`.

Current code (lines 16-20):
```bash
# Download Protoc
wget https://github.com/protocolbuffers/protobuf/releases/download/${PROTOC_TAG}/protoc-${PROTOC_VERSION}-linux-x86_64.zip -O protoc-${PROTOC_VERSION}-linux-x86_64.zip

mkdir -p ${PROTOC_ROOT_FOLDER}/${PROTOC_VERSION}
unzip protoc-${PROTOC_VERSION}-linux-x86_64.zip -d ${PROTOC_ROOT_FOLDER}/${PROTOC_VERSION}
```

Replace with:
```bash
# Download Protoc for detected architecture
wget "https://github.com/protocolbuffers/protobuf/releases/download/${PROTOC_TAG}/protoc-${PROTOC_VERSION}-linux-${PROTOC_ARCH}.zip" -O protoc.zip

# Extract
mkdir -p "${PROTOC_ROOT_FOLDER}/${PROTOC_VERSION}"
unzip protoc.zip -d "${PROTOC_ROOT_FOLDER}/${PROTOC_VERSION}"
```

Key changes:
1. Replace hardcoded `x86_64` with `${PROTOC_ARCH}` in both wget and unzip commands
2. Use generic output filename `protoc.zip` instead of architecture-specific name
3. Quote variables for safety (already done in mkdir line 25+)

Do NOT change:
- The symlink creation at the end (lines 25-28)
- The PATH export line (line 23)
- The `source "${toolpath}/config.sh"` line
- The `set -e` error handling
  </action>
  <verify>
    <automated>grep -q '\${PROTOC_ARCH}' /Users/slazarov/Documents/Scripts/Python/zhipu-projects/podman-debian/scripts/install_protoc.sh && ! grep -q 'linux-x86_64' /Users/slazarov/Documents/Scripts/Python/zhipu-projects/podman-debian/scripts/install_protoc.sh && echo "PASS: PROTOC_ARCH used, x86_64 hardcoded removed" || echo "FAIL: still has hardcoded architecture"</automated>
  </verify>
  <done>install_protoc.sh uses ${PROTOC_ARCH} variable in download URL; no hardcoded x86_64 references remain in wget/unzip commands</done>
</task>

</tasks>

<verification>
After completion:
1. Verify wget URL contains ${PROTOC_ARCH} not hardcoded x86_64
2. Verify unzip command uses generic protoc.zip filename
3. Run `bash -n scripts/install_protoc.sh` to verify syntax is valid
</verification>

<success_criteria>
- [ ] scripts/install_protoc.sh uses ${PROTOC_ARCH} in download URL
- [ ] No hardcoded architecture references (x86_64, amd64) in wget/unzip commands
- [ ] Script syntax is valid (bash -n passes)
- [ ] Symlink and PATH setup remain unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/01-architecture-support/01-03-SUMMARY.md`
</output>
