---
phase: 03-error-handling
plan: 03
type: execute
wave: 3
depends_on: [03-01, 03-02]
files_modified:
  - scripts/build_buildah.sh
  - scripts/build_catatonit.sh
  - scripts/build_conmon.sh
  - scripts/build_crun.sh
  - scripts/build_fuse-overlayfs.sh
  - scripts/build_go-md2man.sh
  - scripts/build_netavark.sh
  - scripts/build_pasta.sh
  - scripts/build_podman.sh
  - scripts/build_runc.sh
  - scripts/build_skopeo.sh
  - scripts/build_slirp4netns.sh
  - scripts/build_toolbox.sh
  - install.sh
autonomous: true
requirements: [ERRO-01, ERRO-02, ERRO-03, ERRO-04]
user_setup: []

must_haves:
  truths:
    - "All build scripts use set -euo pipefail (not commented out)"
    - "All build scripts have error trap calling error_handler"
    - "install.sh shows clear summary when sub-scripts fail"
    - "install.sh propagates errors from sub-scripts to exit immediately"
  artifacts:
    - path: "scripts/build_*.sh"
      provides: "All build scripts with strict error handling"
      contains: "set -euo pipefail"
    - path: "install.sh"
      provides: "Main installer with run_script wrapper for error propagation"
      contains: "run_script()"
  key_links:
    - from: "install.sh"
      to: "scripts/build_*.sh"
      via: "run_script wrapper function"
      pattern: "run_script"
    - from: "install.sh"
      to: "scripts/install_*.sh"
      via: "run_script wrapper function"
      pattern: "run_script"
---

<objective>
Enable strict mode in all remaining build scripts (which have commented `# set -e`) and add error propagation wrapper to install.sh for clear failure summaries.

Purpose: Ensure all build scripts fail immediately on error with clear context, and install.sh provides a clear summary of what failed when sub-scripts error out.

Output: 13 build scripts updated with strict mode, install.sh with run_script() wrapper.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-error-handling/03-RESEARCH.md

<interfaces>
<!-- Key patterns from RESEARCH.md for executor reference -->

Scripts with commented `# set -e` that need enabling:
- scripts/build_buildah.sh
- scripts/build_catatonit.sh
- scripts/build_conmon.sh
- scripts/build_crun.sh
- scripts/build_fuse-overlayfs.sh
- scripts/build_go-md2man.sh
- scripts/build_netavark.sh
- scripts/build_pasta.sh
- scripts/build_podman.sh
- scripts/build_runc.sh
- scripts/build_skopeo.sh
- scripts/build_slirp4netns.sh
- scripts/build_toolbox.sh

run_script() wrapper pattern for install.sh:
```bash
# Track successful/failed components
COMPONENTS_OK=()

# Wrapper function for running sub-scripts with error handling
run_script() {
    local script="$1"
    echo ""
    echo "========================================"
    echo ">>> Starting: ${script}"
    echo "========================================"

    source "${toolpath}/scripts/${script}"

    COMPONENTS_OK+=("${script}")
    echo ">>> Completed: ${script}"
}

# Main installation sequence
main() {
    echo "Podman Debian Compiler - Starting Installation"
    echo "Architecture: ${ARCH}"
    echo ""

    # Dependencies
    run_script "install_dependencies.sh"
    run_script "install_rust.sh"
    # ... etc

    # Success summary
    echo ""
    echo "========================================"
    echo "INSTALLATION COMPLETE"
    echo "========================================"
    echo "Successfully installed ${#COMPONENTS_OK[@]} components"
}

main "$@"
```

NOTE: The run_script wrapper is optional since set -e already causes immediate exit on error. The main benefit is progress tracking and clearer output. The error_handler from 03-01 already provides context on failure.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable strict mode and error traps in all build scripts with commented set -e</name>
  <files>scripts/build_buildah.sh, scripts/build_catatonit.sh, scripts/build_conmon.sh, scripts/build_crun.sh, scripts/build_fuse-overlayfs.sh, scripts/build_go-md2man.sh, scripts/build_netavark.sh, scripts/build_pasta.sh, scripts/build_podman.sh, scripts/build_runc.sh, scripts/build_skopeo.sh, scripts/build_slirp4netns.sh, scripts/build_toolbox.sh</files>
  <action>
For each of the 13 build scripts that have `# set -e` commented out:

1. Change line 4 from `# set -e` to `set -euo pipefail` (uncomment and upgrade)
   - Keep the comment "# Abort on Error" above it

2. Add error trap after sourcing functions.sh (typically after line 14):
   ```bash
   # Set error trap AFTER sourcing
   trap 'error_handler $? $LINENO "$BASH_SOURCE"' ERR
   ```

The trap should be added after the `source "${toolpath}/functions.sh"` line and before any actual operations (before the `cd "${BUILD_ROOT}"` line).

All 13 scripts follow the same pattern, so apply the same transformation to each.
  </action>
  <verify>
    <automated>count=0; for f in scripts/build_buildah.sh scripts/build_catatonit.sh scripts/build_conmon.sh scripts/build_crun.sh scripts/build_fuse-overlayfs.sh scripts/build_go-md2man.sh scripts/build_netavark.sh scripts/build_pasta.sh scripts/build_podman.sh scripts/build_runc.sh scripts/build_skopeo.sh scripts/build_slirp4netns.sh scripts/build_toolbox.sh; do grep -q "set -euo pipefail" "$f" && grep -q "trap 'error_handler" "$f" && ((count++)); done; echo "Updated $count/13 scripts"; test $count -eq 13</automated>
  </verify>
  <done>All 13 build scripts have set -euo pipefail enabled and error traps set</done>
</task>

<task type="auto">
  <name>Task 2: Add run_script wrapper and summary to install.sh for error propagation</name>
  <files>install.sh</files>
  <action>
Modify install.sh to add a run_script wrapper function that tracks progress and provides clear output.

1. After the error trap (added in 03-01), add the tracking arrays and wrapper function:
   ```bash
   # Track installation progress
   COMPONENTS_OK=()

   # Wrapper function for running sub-scripts with error handling
   run_script() {
       local script="$1"
       echo ""
       echo "========================================"
       echo ">>> Starting: ${script}"
       echo "========================================"

       source "${toolpath}/scripts/${script}"

       COMPONENTS_OK+=("${script}")
       echo ">>> Completed: ${script}"
   }
   ```

2. Wrap ALL source statements in run_script() calls. Change from:
   ```bash
   source "${toolpath}/scripts/install_dependencies.sh"
   ```
   To:
   ```bash
   run_script "install_dependencies.sh"
   ```

3. The existing error trap from 03-01 will catch errors and call error_handler, which provides script context and exits. The run_script wrapper adds progress tracking on top.

4. Keep the existing script order - just wrap each source call.

DO NOT add a main() function wrapper - just add run_script and wrap the existing source calls. Keep the script simple.
  </action>
  <verify>
    <automated>grep -q "run_script()" install.sh && grep -c "run_script \"" install.sh | grep -q "1[6-9]\|2[0-9]" && echo "run_script wrapper found with 16+ calls"</automated>
  </verify>
  <done>install.sh has run_script wrapper function wrapping all script sources, providing progress output and tracking</done>
</task>

</tasks>

<verification>
Verify all build scripts and install.sh are updated:

1. Check all 13 build scripts have strict mode enabled (not commented):
   ```bash
   for f in scripts/build_*.sh; do
     grep -q "^set -euo pipefail" "$f" || echo "MISSING STRICT MODE: $f"
   done
   ```

2. Check all 13 build scripts have error trap:
   ```bash
   for f in scripts/build_*.sh; do
     grep -q "trap 'error_handler" "$f" || echo "MISSING TRAP: $f"
   done
   ```

3. Check install.sh has run_script wrapper:
   ```bash
   grep -q "run_script()" install.sh
   ```

4. Check install.sh uses run_script for all sub-scripts (should have 17 calls):
   ```bash
   count=$(grep -c "run_script \"" install.sh)
   echo "run_script calls: $count"
   test $count -ge 16
   ```

5. Verify no commented `# set -e` remains in scripts/:
   ```bash
   ! grep -q "^# set -e$" scripts/*.sh || echo "WARNING: Commented set -e still exists"
   ```
</verification>

<success_criteria>
- All 13 build scripts have `set -euo pipefail` (uncommented, not `# set -e`)
- All 13 build scripts have `trap 'error_handler $? $LINENO "$BASH_SOURCE"' ERR`
- install.sh has run_script() wrapper function
- install.sh wraps all source calls with run_script()
- No scripts have commented `# set -e`
</success_criteria>

<output>
After completion, create `.planning/phases/03-error-handling/03-03-SUMMARY.md`
</output>
