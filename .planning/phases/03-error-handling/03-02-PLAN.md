---
phase: 03-error-handling
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - scripts/install_dependencies.sh
  - scripts/install_go.sh
  - scripts/install_protoc.sh
  - scripts/install_rust.sh
  - scripts/build_aardvark_dns.sh
autonomous: true
requirements: [ERRO-01, ERRO-02, ERRO-03]
user_setup: []

must_haves:
  truths:
    - "All installer scripts use set -euo pipefail (not just set -e)"
    - "All installer scripts have error trap calling error_handler"
    - "Any error in installer scripts outputs script name and line number"
  artifacts:
    - path: "scripts/install_dependencies.sh"
      provides: "Dependency installation with strict error handling"
      contains: "set -euo pipefail"
    - path: "scripts/install_go.sh"
      provides: "Go installation with strict error handling"
      contains: "trap 'error_handler"
    - path: "scripts/install_protoc.sh"
      provides: "Protoc installation with strict error handling"
    - path: "scripts/install_rust.sh"
      provides: "Rust installation with strict error handling"
    - path: "scripts/build_aardvark_dns.sh"
      provides: "Aardvark DNS build with strict error handling"
  key_links:
    - from: "scripts/install_*.sh"
      to: "functions.sh"
      via: "source and trap"
      pattern: "trap 'error_handler"
---

<objective>
Update installer scripts that already have active `set -e` to use full strict mode (`set -euo pipefail`) and error trapping.

Purpose: Ensure all dependency and toolchain installer scripts fail immediately on any error and provide clear context about what failed.

Output: 5 scripts updated with strict mode and error traps.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-error-handling/03-RESEARCH.md

<interfaces>
<!-- Key patterns from RESEARCH.md and 03-01 for executor reference -->

Target strict mode header pattern for executable scripts:
```bash
#!/bin/bash

# Strict Mode - Exit on error, undefined vars, pipe failures
set -euo pipefail

# Determine toolpath if not set already
relativepath="../"
if [[ ! -v toolpath ]]; then
    scriptpath=$(cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd)
    toolpath=$(realpath --canonicalize-missing "${scriptpath}/${relativepath}")
fi

# Load Configuration
source "${toolpath}/config.sh"

# Load Functions (includes error_handler from 03-01)
source "${toolpath}/functions.sh"

# Set error trap AFTER sourcing
trap 'error_handler $? $LINENO "$BASH_SOURCE"' ERR
```

Scripts to update (currently have `set -e` on line 4):
- scripts/install_dependencies.sh
- scripts/install_go.sh
- scripts/install_protoc.sh
- scripts/install_rust.sh
- scripts/build_aardvark_dns.sh

Each script needs:
1. Change `set -e` to `set -euo pipefail`
2. Add `trap 'error_handler $? $LINENO "$BASH_SOURCE"' ERR` after sourcing functions.sh
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update install_dependencies.sh with strict mode and error trap</name>
  <files>scripts/install_dependencies.sh</files>
  <action>
Modify scripts/install_dependencies.sh:

1. Change line 4 from `set -e` to `set -euo pipefail`
   - Keep the comment "# Abort on Error" above it

2. Add error trap after sourcing functions.sh (after line 14):
   ```bash
   # Set error trap AFTER sourcing
   trap 'error_handler $? $LINENO "$BASH_SOURCE"' ERR
   ```

3. The cd command on line 17 uses `|| exit` which is now redundant with set -e, but harmless - leave it as is.
  </action>
  <verify>
    <automated>grep -q "set -euo pipefail" scripts/install_dependencies.sh && grep -q "trap 'error_handler" scripts/install_dependencies.sh</automated>
  </verify>
  <done>install_dependencies.sh uses set -euo pipefail and has error trap</done>
</task>

<task type="auto">
  <name>Task 2: Update install_go.sh, install_protoc.sh, install_rust.sh with strict mode and error traps</name>
  <files>scripts/install_go.sh, scripts/install_protoc.sh, scripts/install_rust.sh</files>
  <action>
For each of the three scripts (install_go.sh, install_protoc.sh, install_rust.sh):

1. Change line 4 from `set -e` to `set -euo pipefail`
   - Keep the comment "# Abort on Error" above it

2. Add error trap after sourcing functions.sh:
   ```bash
   # Set error trap AFTER sourcing
   trap 'error_handler $? $LINENO "$BASH_SOURCE"' ERR
   ```

The trap should be added after the `source "${toolpath}/functions.sh"` line and before any actual operations.
  </action>
  <verify>
    <automated>for f in scripts/install_go.sh scripts/install_protoc.sh scripts/install_rust.sh; do grep -q "set -euo pipefail" "$f" && grep -q "trap 'error_handler" "$f" || exit 1; done && echo "All 3 installer scripts updated"</automated>
  </verify>
  <done>All three toolchain installer scripts use set -euo pipefail and have error traps</done>
</task>

<task type="auto">
  <name>Task 3: Update build_aardvark_dns.sh with strict mode and error trap</name>
  <files>scripts/build_aardvark_dns.sh</files>
  <action>
Modify scripts/build_aardvark_dns.sh:

1. Change line 4 from `set -e` to `set -euo pipefail`
   - Keep the comment "# Abort on Error" above it

2. Add error trap after sourcing functions.sh:
   ```bash
   # Set error trap AFTER sourcing
   trap 'error_handler $? $LINENO "$BASH_SOURCE"' ERR
   ```

This script already has active set -e (not commented), so it just needs the upgrade.
  </action>
  <verify>
    <automated>grep -q "set -euo pipefail" scripts/build_aardvark_dns.sh && grep -q "trap 'error_handler" scripts/build_aardvark_dns.sh</automated>
  </verify>
  <done>build_aardvark_dns.sh uses set -euo pipefail and has error trap</done>
</task>

</tasks>

<verification>
Verify all installer scripts have strict mode and error traps:

1. Check all 5 scripts have strict mode:
   ```bash
   for f in scripts/install_dependencies.sh scripts/install_go.sh scripts/install_protoc.sh scripts/install_rust.sh scripts/build_aardvark_dns.sh; do
     grep -q "set -euo pipefail" "$f" || echo "MISSING: $f"
   done
   ```

2. Check all 5 scripts have error trap:
   ```bash
   for f in scripts/install_dependencies.sh scripts/install_go.sh scripts/install_protoc.sh scripts/install_rust.sh scripts/build_aardvark_dns.sh; do
     grep -q "trap 'error_handler" "$f" || echo "MISSING: $f"
   done
   ```

3. Verify no scripts have old `set -e` alone:
   ```bash
   for f in scripts/install_*.sh scripts/build_aardvark_dns.sh; do
     ! grep -q "^set -e$" "$f" || echo "OLD PATTERN: $f"
   done
   ```
</verification>

<success_criteria>
- All 5 scripts have `set -euo pipefail` (not just `set -e`)
- All 5 scripts have `trap 'error_handler $? $LINENO "$BASH_SOURCE"' ERR`
- No script uses `set -e` alone
</success_criteria>

<output>
After completion, create `.planning/phases/03-error-handling/03-02-SUMMARY.md`
</output>
